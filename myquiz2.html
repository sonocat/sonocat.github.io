<!DOCTYPE html>
<html>
	<head>
		<title>SonoCat - Practical Guide to General Sonography</title>
		
		<script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.js"></script>
		
		<style type="text/css">
			body {
				background: #fff;
				text-align: center;
			}
			ol, ul {
				list-style: none;
			}
			#frame {
				max-width: 700px;
				width: auto;
				border: 1px solid #ccc;
				background: #fff;
				padding: 11px;
				margin: 11px auto;
				text-align: left;
			}
			h1 {
				font: bold 19px Arial;
				color: #000;
				text-transform: uppercase;
				line-height: 33px; 
				padding-left: 9px;
				margin: 0;
				border-bottom: 2px solid #000;
			}
			h2 {
				font: 21px "Times New Roman";
				padding: 0 9px;
				margin: 15px 0;
				text-align: center;
			}
			p.pager {
				margin: 5px 9px;
				font: bold 17px Arial;
				color: #999;
			}
			img.question-image {
				display: block;
				max-width: 250px;
				margin: 10px auto;
				border: 1px solid #ccc;
				width: 100%;
				height: auto;
			}
			#choice-block {
				display: block;
				list-style: none;
				margin: 0;
				padding: 0;
			}
			#submitbutton {
				background: #5a6b8c;
			}
			#submitbutton:hover {
				background: #7b8da6;
			}
			#explanation {
				margin: 0 auto;
				padding: 20px;
				width: 75%;
			}
			.choice-box {
				display: block;
				font: 15px Arial;
				text-align: center;
				margin: 8px auto;
				padding: 10px 0;
				border: 1px solid #666;
				cursor: pointer;
				-webkit-border-radius: 5px;
				-moz-border-radius: 5px;
				border-radius: 5px;
			}
		</style>
		
		<script id="insert"></script>
		<script src="/stringify.js" charset="utf-8"></script>
		<script>
			const customConsole = (w) => {
				const pushToConsole = (payload, type) => {
					w.parent.postMessage({
						console: {
							payload: stringify(payload),
							type: type
						}
				}, "*")
			}
			w.onerror = (message, url, line, column) => {
				// the line needs to correspond with the editor panel
				// unfortunately this number needs to be altered every time this view is changed
				line = line - 70
				if (line < 0){
					pushToConsole(message, "error")
				} else {
					pushToConsole(`[${line}:${column}] ${message}`, "error")
				}
			}
				
			let console = (function(systemConsole){
				return {
					log: function(){
						let args = Array.from(arguments)
						pushToConsole(args, "log")
						systemConsole.log.apply(this, args)
					},
					info: function(){
						let args = Array.from(arguments)
						pushToConsole(args, "info")
						systemConsole.info.apply(this, args)
					},
					warn: function(){
						let args = Array.from(arguments)
						pushToConsole(args, "warn")
						systemConsole.warn.apply(this, args)
					},
					error: function(){
						let args = Array.from(arguments)
						pushToConsole(args, "error")
						systemConsole.error.apply(this, args)
					},
					system: function(arg){
						pushToConsole(arg, "system")
					},
					clear: function(){
						systemConsole.clear.apply(this, {})
					},
					time: function(){
						let args = Array.from(arguments)
						systemConsole.time.apply(this, args)
					},
					assert: function(assertion, label){
						if (!assertion){
							pushToConsole(label, "log")
					}
						
					let args = Array.from(arguments)
					systemConsole.assert.apply(this, args)
				}
			}
		}(window.console))
				
				window.console = { ...window.console, ...console } 
				console.system("Running fiddle")
		}
		if (window.parent){
			customConsole(window)
		}
		
		</script>
	</head>
	
	<body>
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	
	<div id="frame" role="content">
		
		<script type="text/javascript">//<![CDATA[
			
			var quiztitle = "Social Security Quiz";
			var quiz = [
				{
					"question" : "What might you expect to find in a patient s/p vasectomy?",
					"image" : "http://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Albert_Einstein_Head.jpg/220px-Albert_Einstein_Head.jpg",
					"choices" : [
						"Epididymal mass",
						"Varicoceles",
						"Dilated epididymis",
						"Both epididymal mass and dilated epididymis"
					],
					"correct" : "Both epididymal mass and dilated epididymis",
					"explanation" : "Surgical history is important and you should know when to ask them. If you find an enlarged and cystic epididymis, or an epididymal mass, ask the patient if he has had a vasectomy. Read more about sperm granuloma and tubular ectasia of epididymis. (Insert images below).",
				},
				{
					"question" : "Where is a sperm granuloma found? ",
					"image" : "http://upload.wikimedia.org/wikipedia/commons/thumb/9/94/US_%242_obverse-high.jpg/320px-US_%242_obverse-high.jpg",
					"choices" : [
						"Within testis",
						"Within epididymis",
						"Within hydrocele, free floating"
					],
					"correct" : "Within epididymis",
					"explanation" : "Read about sperm granuloma (opens in new window).",
				},
				{
					"question" : "This is the sagittal midline testis image of a fertility patient, a new finding since his last prior ultrasound. What should be your suspicion, after confirming the patientâ€™s medical history?",
					"image" : "",
					"choices" : [
						"S/P varicocelectomy ",
						"S/P microTESE",
						"Testicular atrophy",
						"Testicular lobulation"
					],
					"correct" : "S/P microTESE",
					"explanation" : "Since the finding is new, you should suspect that this is a scar from a recent procedure or biopsy. Testicular lobulation looks very similar and can cause infertility, but is congenital and would have been seen in previous imaging. Testicular atrophy is seen in older men, and has the appearance of multiple hypoechoic striations.",
				},
			];
			
			var currentquestion = 0,
				score = 0,
				submt = true,
				picked;
			
			jQuery(document).ready(function ($) {
			
			function htmlEncode(value) {
				return $(document.createElement('div')).text(value).html();
			}
			
			function addChoices(choices) {
				if (typeof choices !== "undefined" && $.type(choices) == "array") {
					$('#choice-block').empty();
					for (var i = 0; i < choices.length; i++) {
						$(document.createElement('li')).addClass('choice choice-box').attr('data-index', i).text(choices[i]).appendTo('#choice-block');
					}
				}
			}
			
			function nextQuestion() {
				submt = true;
				$('#explanation').empty();
				$('#question').text(quiz[currentquestion]['question']);
				$('#pager').text('Question ' + Number(currentquestion + 1) + ' of ' + quiz.length);
				if (quiz[currentquestion].hasOwnProperty('image') && quiz[currentquestion]['image'] != "") {
					if ($('#question-image').length == 0) {
						$(document.createElement('img')).addClass('question-image').attr('id', 'question-image').attr('src', quiz[currentquestion]['image']).attr('alt', htmlEncode(quiz[currentquestion]['question'])).insertAfter('#question');
					} else {
						$('#question-image').attr('src', quiz[currentquestion]['image']).attr('alt', htmlEncode(quiz[currentquestion]['question']));
					}
				} else {
					$('#question-image').remove();
				}
				addChoices(quiz[currentquestion]['choices']);
				setupButtons();
			}
			
			function processQuestion(choice) {
				if (quiz[currentquestion]['choices'][choice] == quiz[currentquestion]['correct']) {
					$('.choice').eq(choice).css({
 						'background-color': '#50D943'
					});
					$('#explanation').html('<strong>Correct!</strong> ' + htmlEncode(quiz[currentquestion]['explanation']));
					score++;
				} else {
					$('.choice').eq(choice).css({
						'background-color': '#D92623'
					});
					$('#explanation').html('<strong>Incorrect.</strong> ' + htmlEncode(quiz[currentquestion]['explanation']));
				}
				currentquestion++;
				$('#submitbutton').html('NEXT QUESTION &raquo;').on('click', function () {
					if (currentquestion == quiz.length) {
						endQuiz();
					} else {
						$(this).text('Check Answer').css({
						'color': '#222'
						}).off('click');
						nextQuestion();
					}
				})
			}
			
			function setupButtons() {
				$('.choice').on('mouseover', function () {
					$(this).css({
						'background-color': '#e1e1e1'
					});
				});
				$('.choice').on('mouseout', function () {
					$(this).css({
						'background-color': '#fff'
					});
				})
				$('.choice').on('click', function () {
					picked = $(this).attr('data-index');
					$('.choice').removeAttr('style').off('mouseout mouseover');
					$(this).css({
						'border-color': '#222',
						'font-weight': 700,
						'background-color': '#c1c1c1'
					});
					if (submt) {
						submt = false;
						$('#submitbutton').css({
							'color': '#000'
						}).on('click', function () {
							$('.choice').off('click');
							$(this).off('click');
							processQuestion(picked);
						});
					}
				})
			}
			
			function endQuiz() {
				$('#explanation').empty();
				$('#question').empty();
				$('#choice-block').empty();
				$('#submitbutton').remove();
				$('#question').text("You got " + score + " out of " + quiz.length + " correct.");
				$(document.createElement('h2')).css({
					'text-align': 'center',
					'font-size': '4em'
				}).text(Math.round(score / quiz.length * 100) + '%').insertAfter('#question');
			}
			
			function init() {
				//add title
				if (typeof quiztitle !== "undefined" && $.type(quiztitle) === "string") {
					$(document.createElement('h1')).text(quiztitle).appendTo('#frame');
				} else {
					$(document.createElement('h1')).text("Quiz").appendTo('#frame');
				}
				//add pager and questions
				if (typeof quiz !== "undefined" && $.type(quiz) === "array") {
					//add pager
					$(document.createElement('p')).addClass('pager').attr('id', 'pager').text('Question 1 of ' + quiz.length).appendTo('#frame');
					//add first question
					$(document.createElement('h2')).addClass('question').attr('id', 'question').text(quiz[0]['question']).appendTo('#frame');
					//add image if present
					if (quiz[0].hasOwnProperty('image') && quiz[0]['image'] != "") {
						$(document.createElement('img')).addClass('question-image').attr('id', 'question-image').attr('src', quiz[0]['image']).attr('alt', htmlEncode(quiz[0]['question'])).appendTo('#frame');
					}
					$(document.createElement('p')).addClass('explanation').attr('id', 'explanation').html('&nbsp;').appendTo('#frame');
					//questions holder
					$(document.createElement('ul')).attr('id', 'choice-block').appendTo('#frame');
					//add choices
					addChoices(quiz[0]['choices']);
					//add submit button
					$(document.createElement('div')).addClass('choice-box').attr('id', 'submitbutton').text('Check Answer').css({
						'font-weight': 700,
						'color': '#222',
						'padding': '30px 0'
					}).appendTo('#frame');
					setupButtons();
				}
			}
			init();
		});
	//]]></script>
		
		<script>
			// tell the embed parent frame the height of the content
			if (window.parent && window.parent.parent){
				window.parent.parent.postMessage(["resultsFrame", {
					height: document.body.getBoundingClientRect().height,
					slug: "7Du6N"
				}], "*")
			}
			// always overwrite window.name, in case users try to set it manually
			window.name = "result"
		</script>
		
		<script>
			let allLines = []
			
			window.addEventListener("message", (message) => {
				if (message.data.console){
					let insert = document.querySelector("#insert")
					allLines.push(message.data.console.payload)
					insert.innerHTML = allLines.join(";\r")
					
					let result = eval.call(null, message.data.console.payload)
					if (result !== undefined){
						console.log(result)
					}
				}
			})
		</script>
	</div>
		
	</body>
</html>
